#!/bin/sh

# Log
fn_log "$CALL_PROC" "$LOG_LABEL_INFO Execute file: $THIS_FILE_NAME"

#-----------------------------------------
# 2022-04-19 - Captive Portal <<<
#-----------------------------------------
if [ ! -f /var/named/data/trusted-policy.db ];then
	touch /var/named/data/trusted-policy.db
fi
if [ ! -f /var/named/data/response-policy.db ];then
	touch /var/named/data/response-policy.db
fi
if [ ! -f /var/named/data/local-logout-policy.db ];then
	touch /var/named/data/local-logout-policy.db
fi
if [ ! -f /var/named/data/logout-policy.db ];then
	touch /var/named/data/logout-policy.db
fi
if [ ! -f /etc/flashstart-hybrid/trusted_domain.list ];then
	touch /etc/flashstart-hybrid/trusted_domain.list
fi

if [ ! -d "/etc/flashstart-hybrid/google/" ]; then
	mkdir /etc/flashstart-hybrid/google/
	touch /etc/flashstart-hybrid/google/auth_trusted_domain.list
fi

if [ ! -f /etc/flashstart-hybrid/api_credentials ];then
	touch /etc/flashstart-hybrid/api_credentials
fi

# create symbolic link
if [ ! -L /etc/e-smith/events/nethserver-flashstart-save/S98sysctld-update ];then 
	ln -s ../actions/flashstarthybrid-sysctld-update /etc/e-smith/events/nethserver-flashstart-save/S98sysctld-update
fi
if [ ! -L /etc/e-smith/events/interface-update/S80interface-loopback ];then 
	ln -s ../actions/flashstarthybrid-init /etc/e-smith/events/interface-update/S80interface-loopback
fi
if [ ! -L /etc/e-smith/events/host-create/S99flashstarthybrid-object-update ];then 
	ln -s ../actions/flashstarthybrid-object-update /etc/e-smith/events/host-create/S99flashstarthybrid-object-update
fi
if [ ! -L /etc/e-smith/events/host-delete/S99flashstarthybrid-object-update ];then 
	ln -s ../actions/flashstarthybrid-object-update /etc/e-smith/events/host-delete/S99flashstarthybrid-object-update
fi
if [ ! -L /etc/e-smith/events/host-modify/S99flashstarthybrid-object-update ];then 
	ln -s ../actions/flashstarthybrid-object-update /etc/e-smith/events/host-modify/S99flashstarthybrid-object-update
fi 

# check directory for php fpm
if [ ! -d "/etc/opt/rh/rh-php72/php-fpm.d/" ]; then
	mkdir -p /etc/opt/rh/rh-php72/php-fpm.d/
fi

# install/update Google  Python Library
pip3 install --upgrade google-api-python-client google-auth-httplib2 google-auth-oauthlib validators prettytable oauth2client
CHECK_LIB=$(pip3 show google-api-python-client | grep "Version" | wc -l)
if [ "$CHECK_LIB" == "0" ]; then
	# install with version
	pip3 install --ignore-requires-python google-api-python-client==2.48.0
	pip3 install --ignore-requires-python google-auth-httplib2
	pip3 install --ignore-requires-python google-auth-oauthlib==0.5.1
	pip3 install --ignore-requires-python validators==0.19.0
	pip3 install --ignore-requires-python prettytable==2.5.0
	pip3 install --ignore-requires-python oauth2client==4.1.3
fi

# check directory for dns rpz
if [ ! -d "/var/named/data/dns_rpz_list/" ]; then
	mkdir -p /var/named/data/dns_rpz_list/
fi
# check file for dns rpz
if [ ! -f /var/named/data/views_dns_rpz ];then
	touch /var/named/data/views_dns_rpz
fi
# check/create action
if [ ! -L /etc/e-smith/events/host-create/S90fshybrid-dnsrpz ];then 
	ln -s ../actions/flashstarthybrid-dnsrpz /etc/e-smith/events/host-create/S90fshybrid-dnsrpz
fi
if [ ! -L /etc/e-smith/events/host-create/S99rndc-reload ];then 
	ln -s ../actions/flashstarthybrid-rndc-reload /etc/e-smith/events/host-create/S99rndc-reload
fi

if [ ! -L /etc/e-smith/events/host-modify/S90fshybrid-dnsrpz ];then 
	ln -s ../actions/flashstarthybrid-dnsrpz /etc/e-smith/events/host-modify/S90fshybrid-dnsrpz
fi
if [ ! -L /etc/e-smith/events/host-modify/S99rndc-reload ];then 
	ln -s ../actions/flashstarthybrid-rndc-reload /etc/e-smith/events/host-modify/S99rndc-reload
fi

if [ ! -L /etc/e-smith/events/host-delete/S90fshybrid-dnsrpz ];then 
	ln -s ../actions/flashstarthybrid-dnsrpz /etc/e-smith/events/host-delete/S90fshybrid-dnsrpz
fi
if [ ! -L /etc/e-smith/events/host-delete/S99rndc-reload ];then 
	ln -s ../actions/flashstarthybrid-rndc-reload /etc/e-smith/events/host-delete/S99rndc-reload
fi
if [ ! -L /etc/e-smith/events/interface-update/S99flashstarthybrid-send-settings ];then 
	ln -s ../actions/flashstarthybrid-send-settings /etc/e-smith/events/interface-update/S99flashstarthybrid-send-settings
fi

if [ ! -L /etc/e-smith/events/flashstarthybrid-configure-catch-all/S99rndc-reload ];then 
	ln -s ../actions/flashstarthybrid-rndc-reload /etc/e-smith/events/flashstarthybrid-configure-catch-all/S99rndc-reload
fi

# change logrotate configuration
LOGROTATE_TIME=$($ESMITH_CONFIG getprop logrotate Times)
if [ "$LOGROTATE_TIME" == "52" ]; then
	$ESMITH_CONFIG setprop logrotate Times 5
fi

#-----------------------------------------
# set end var
#-----------------------------------------
UPDPOST_SERVICE_RELOAD=1
UPDPOST_SEND_SETTINGS=1

# >>>


